---
title: "Weekly Strava report"
params:
  user: "raphael"
format:
  html:
    self-contained: true
---

```{r setup}

# # restore r-environment with loaded pacakges. At project-initialization this has already been done.
# renv::restore()

# ---- Load libraries ----
library(here)
library(tidyverse)      # includes dplyr, ggplot2, readr, etc.
library(sessioninfo)
library(RColorBrewer)
library(svglite)
library(viridis)
library(patchwork)
library(lubridate)
library(hms)
library(janitor)
library(slider)

# set filter preference
library(conflicted)
conflict_prefer("filter", "dplyr")

# ---- renv management ----
# This project already has renv initialized via setup script.
# If you install new packages, run:
#   install.packages("pkgname")
#   renv::snapshot()
```

```{r}
source(here("R", "theme_layout.R"))
```

# import data

```{r}

user <- params$user
csv_path <- here("data", "processed", user, "activities.csv")


# data_path <- here::here("data", "processed", "activities.csv")
# raw_path <- here("data/raw/export_26195219/activities.csv")

acts_raw <- read_csv(csv_path, show_col_types = FALSE)

glimpse(acts_raw)

# tmp <- names(acts_raw) %>%
#   tibble(name = .) %>%
#   filter(str_detect(name, "Dist"))
# 
# acts_raw %>% select(all_of(tmp$name)

```

```{r}
df_minimal <- acts_raw %>% 
  select(id, sport_type, distance, moving_time, elapsed_time, start_date_local) %>% 
  rename(
    "activity_id" = "id",
    "activity_type" = "sport_type",
    "activity_date" = "start_date_local"
  )
```

```{r}
# combine sport activites into groups
df_minimal <- df_minimal %>% 
  mutate(
    activity_type = case_when(
      activity_type %in% c("Run", "TrailRun", "Hike") ~ "Running",
      activity_type %in% c("Ride", "GravelRide") ~ "Cycling",
      activity_type %in% c("WeightTraining", "Workout") ~ "Strength",
      activity_type == "Swim" ~ "Swimming",
      TRUE ~ activity_type
    )
  )

 # filter for activities with at least 10 recordings

activities <- df_minimal %>% 
  group_by(activity_type) %>% 
  summarise(number= n()) %>%
  # filter(number>10) %>% 
  pull(activity_type)

```

```{r}

df_minimal <- df_minimal %>%
  mutate(
    activity_date = ymd_hms(activity_date),
    year  = year(activity_date),
    month = month(activity_date),
    day   = day(activity_date),
    date = date(activity_date),
    elapsed_hms = hms::as_hms(elapsed_time),
    moving_time = hms::as_hms(moving_time)
  ) %>% 
  group_by(year, month, activity_type) %>% 
  mutate(moving_time_hr = as.numeric(moving_time) / 3600) %>% 
  filter(activity_type %in% activities) # filter for activities with at least 10 recordings
```

```{r}
cols <- setNames(
  viridis::viridis(length(activities)),
  activities
)

plotting_geom_cont <- function(dat, x_var = "month", y_var, color) {
  this_type <- unique(dat$activity_type)
  
  ggplot(dat, aes(x = !!sym(x_var), y = !!sym(y_var), fill = activity_type)) +
     # facet_grid(year ~ ., scales = "fixed") +
    scale_y_continuous(limits = c(0,NA), expand = expansion(mult=c(0.05,0.1))) +
    scale_fill_manual(values = color) +
    labs(
      title = this_type,
      x = "Month"
    ) +
    theme_layout +
    theme(
      strip.background = element_rect("grey80"),
      legend.position = "none",
      panel.grid.major = element_line(color = "grey90"),
      plot.title = element_text(hjust=0.5)
    )
}
```

```{r}

# Enhanced function with smoothing options
add_rolling_metrics <- function(df, col_name, smooth = FALSE, smooth_span = 0.1) {
  df_out <- df %>%
    arrange(activity_type, date) %>%
    group_by(activity_type) %>%
    mutate(
      "{col_name}_mean_7d" := slide_index_dbl(
        .data[[col_name]], .i = date, .f = mean, .before = days(7)
      ),
      "{col_name}_mean_30d" := slide_index_dbl(
        .data[[col_name]], .i = date, .f = mean, .before = days(30)
      ),
      "{col_name}_mean_90d" := slide_index_dbl(
        .data[[col_name]], .i = date, .f = mean, .before = days(90)
      ),
      "{col_name}_sum_7d" := slide_index_dbl(
        .data[[col_name]], .i = date, .f = sum, .before = days(7)
      ),
      "{col_name}_sum_30d" := slide_index_dbl(
        .data[[col_name]], .i = date, .f = sum, .before = days(30)
      ),
      "{col_name}_sum_60d" := slide_index_dbl(
        .data[[col_name]], .i = date, .f = sum, .before = days(60)
      )
    )
  
  # Add smoothed versions if requested
  if (smooth) {
    df_out <- df_out %>%
      mutate(
        "{col_name}_mean_7d_smooth" := predict(
          loess(get(paste0(col_name, "_mean_7d")) ~ as.numeric(date), 
                span = smooth_span, na.action = na.exclude)
        ),
        "{col_name}_mean_30d_smooth" := predict(
          loess(get(paste0(col_name, "_mean_30d")) ~ as.numeric(date), 
                span = smooth_span, na.action = na.exclude)
        ),
        "{col_name}_mean_90d_smooth" := predict(
          loess(get(paste0(col_name, "_mean_90d")) ~ as.numeric(date), 
                span = smooth_span, na.action = na.exclude)
        ),
               "{col_name}_sum_7d_smooth" := predict(
          loess(get(paste0(col_name, "_sum_7d")) ~ as.numeric(date), 
                span = smooth_span, na.action = na.exclude)
        ),
        "{col_name}_sum_30d_smooth" := predict(
          loess(get(paste0(col_name, "_sum_30d")) ~ as.numeric(date), 
                span = smooth_span, na.action = na.exclude)
        ),
         "{col_name}_sum_60d_smooth" := predict(
          loess(get(paste0(col_name, "_sum_60d")) ~ as.numeric(date), 
                span = smooth_span, na.action = na.exclude)
        )
      )
  }
  
  df_out %>% ungroup()
}

# Use it
df_minimal_ma <- df_minimal %>%
  mutate(distance = distance / 1000) %>% 
  add_rolling_metrics("distance", smooth = FALSE, smooth_span = 0.05) %>%
  add_rolling_metrics("moving_time_hr", smooth = FALSE, smooth_span = 0.05)

names(df_minimal_ma)
```

```{r, fig.width=40/2.54, fig.height=20/2.54}
plotting_overview <- function(df, x_var, y_var, show_smoothed = TRUE){
  
  # Build column names dynamically
  ma_7d_col <- paste0(y_var, "_mean_7d_smooth")
  ma_30d_col <- paste0(y_var, "_mean_30d_smooth")
  ma_90d_col <- paste0(y_var, "_mean_90d_smooth")
  ma_7d_sum_col <- paste0(y_var, "_sum_7d")
  ma_30d_sum_col <- paste0(y_var, "_sum_30d")
  ma_60d_sum_col <- paste0(y_var, "_sum_60d")
  
  linewidth_var <- 0.5
  alpha_var <- 0.7

  
  plots_activity <- df %>%
    split(.$activity_type) %>%
    map(function(data) {
      p <- plotting_geom_cont(data, x_var = x_var, y_var = y_var, color = cols) + 
        geom_jitter(width = 0.2, shape = 21, alpha = 0.5) 

      # Add smoothed lines if they exist and show_smoothed is TRUE
      if (show_smoothed && ma_7d_col %in% names(data)) {
        p <- p +
          geom_line(aes(y = .data[[ma_7d_col]]),
                    color = "grey40", linewidth = 1, alpha = alpha_var)
        }
      return(p)
    })
  
  plots_sum <- df %>% 
      split(.$activity_type) %>%
    map(function(data) {
      plotting_geom_cont(data, x_var = x_var, y_var = y_var, color = cols) + 
      geom_line(
        aes(y = .data[[ma_7d_sum_col]] / 7, colour = "7d"),
        linewidth = linewidth_var, alpha = alpha_var
        ) +
        geom_line(
          aes(y = .data[[ma_30d_sum_col]] / 30, colour = "30d"),
          linewidth = linewidth_var, alpha = alpha_var
        ) +
        geom_line(
          aes(y = .data[[ma_60d_sum_col]] / 60, colour = "60d"),
          linewidth = linewidth_var, alpha = alpha_var
        ) +
      scale_colour_manual(
      name   = "Moving average / day",
      limits = c("7d", "30d", "60d"),
      values = c(
        "7d"  = "grey70",
        "30d" = "grey30",
        "60d" = "black"
        )
      ) 
      })
  
  return(list(
    plots_activity = plots_activity,
    plots_sum = plots_sum
  )
  )
}

# Usage
## distance
plots_180_dist <- plotting_overview(
  df_minimal_ma %>% filter(
    date >= today() - days(180),
    !activity_type %in% "Strength" # remove strength for distance plots
    ),
  x_var = "date", 
  y_var = "distance"
) 

plots_720_dist <- plotting_overview(
 df_minimal_ma %>% filter(
    date >= today() - days(720),
    !activity_type %in% "Strength" # remove strength for distance plots
    ),
  x_var = "date", 
  y_var = "distance"
) 

## time
plots_180_time <- plotting_overview(
  df_minimal_ma %>% filter(date >= today() - days(180)),
  x_var = "date", 
  y_var = "moving_time_hr"
) 

plots_720_time <- plotting_overview(
  df_minimal_ma %>% filter(date >= today() - days(720)),
  x_var = "date", 
  y_var = "moving_time_hr"
) 

```


```{r, fig.height=30/2.54}
wrapping_plots <- function(plots_180, plots_720, empty_msg = "No activities available for this metric.") {

  # Helper: placeholder plot so downstream patchwork ops (& labs, & theme) still work
  empty_panel <- function(msg) {
    ggplot2::ggplot() +
      ggplot2::annotate("text", x = 0, y = 0, label = msg, size = 4) +
      ggplot2::xlim(-1, 1) + ggplot2::ylim(-1, 1) +
      ggplot2::theme_void()
  }

  # Guard: missing or empty activity list
  acts <- names(plots_720$plots_activity)
  if (is.null(acts) || length(acts) == 0) {
    return(empty_panel(empty_msg))
  }

  # Build plots list: always 4 per activity in the order you intend
  plots_to_wrap <- unlist(
    lapply(acts, function(act) {
      list(
        plots_720$plots_activity[[act]],
        plots_720$plots_sum[[act]],
        plots_180$plots_activity[[act]],
        plots_180$plots_sum[[act]]
      )
    }),
    recursive = FALSE
  )

  # Keep only ggplot/grob objects (drop NULLs and anything else)
  plots_to_wrap <- Filter(
    function(p) inherits(p, "ggplot") || inherits(p, "grob"),
    plots_to_wrap
  )

  # If everything got dropped, return placeholder
  if (length(plots_to_wrap) == 0) {
    return(empty_panel(empty_msg))
  }

  # You are designing for 4 plots per activity: 2 full-width rows + 1 split row
  n_plots_per_activity <- 4

  designs <- lapply(seq_along(acts), function(i) {
    offset <- (i - 1) * n_plots_per_activity

    full_width_rows <- sapply(1:(n_plots_per_activity - 2), function(j) {
      letter <- LETTERS[j + offset]
      paste0(letter, letter)
    })

    split_row <- paste0(
      LETTERS[n_plots_per_activity - 1 + offset],
      LETTERS[n_plots_per_activity + offset]
    )

    c(full_width_rows, split_row)
  })

  design <- paste(unlist(designs), collapse = "\n")

  patchwork::wrap_plots(plots_to_wrap, design = design)
}

plot_summary_dist <- wrapping_plots(plots_180_dist, plots_720_dist) & labs(y="km") & theme(axis.title.x = element_blank())
plot_summary_time <- wrapping_plots(plots_180_time, plots_720_time) & labs(y="hours") & theme(axis.title.x = element_blank())
```


```{r}

fig_dir <- file.path("figures", user)
dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)

# dir.create("figures", recursive = TRUE, showWarnings = FALSE)

ggsave(
  filename = file.path(fig_dir, "weekly_distance.pdf"),
  plot = plot_summary_dist,
  width = 30,
  height = 15*length(activities),
  units = "cm",
  device = cairo_pdf,
  limitsize = FALSE
)

ggsave(
  filename = file.path(fig_dir, "weekly_time.pdf"),
  plot = plot_summary_time,
  width = 30,
  height = 15*length(activities),
  units = "cm",
  device = cairo_pdf,
  limitsize = FALSE
)
```
