name: Weekly Strava report

on:
  workflow_dispatch:
  schedule:
    # Sundays 21:00 UTC
    - cron: "0 19 * * 0"

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    
    env:
      MAIL_TO_RAPHAEL: ${{ secrets.MAIL_TO_RAPHAEL }}
      MAIL_TO_LAUREN: ${{ secrets.MAIL_TO_LAUREN }}
            
    strategy:
      fail-fast: false
      matrix:
        user: [raphael]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install R packages (renv)
        uses: r-lib/actions/setup-renv@v2

      - name: Sync Strava activities (per user)
        env:
          STRAVA_RAPHAEL_CLIENT_ID: ${{ secrets.STRAVA_RAPHAEL_CLIENT_ID }}
          STRAVA_RAPHAEL_CLIENT_SECRET: ${{ secrets.STRAVA_RAPHAEL_CLIENT_SECRET }}
          STRAVA_RAPHAEL_REFRESH_TOKEN: ${{ secrets.STRAVA_RAPHAEL_REFRESH_TOKEN }}

          STRAVA_LAUREN_CLIENT_ID: ${{ secrets.STRAVA_LAUREN_CLIENT_ID }}
          STRAVA_LAUREN_CLIENT_SECRET: ${{ secrets.STRAVA_LAUREN_CLIENT_SECRET }}
          STRAVA_LAUREN_REFRESH_TOKEN: ${{ secrets.STRAVA_LAUREN_REFRESH_TOKEN }}
        run: |
          python scripts/strava_sync.py ${{ matrix.user }}

      - name: Render report (per user)
        run: |
          quarto render reports/quarto_template.qmd -P user:${{ matrix.user }}

      - name: List generated PDFs (debug)
        run: |
          ls -lah reports/figures/${{ matrix.user }} || true
          ls -lah reports/figures/${{ matrix.user }}/*.pdf || true
          
      - name: Select recipient
        run: |
          if [ "${{ matrix.user }}" = "raphael" ]; then
            echo "MAIL_TO=${MAIL_TO_RAPHAEL}" >> $GITHUB_ENV
          elif [ "${{ matrix.user }}" = "lauren" ]; then
            echo "MAIL_TO=${MAIL_TO_LAUREN}" >> $GITHUB_ENV
          else
            echo "Unknown user: ${{ matrix.user }}"
            exit 1
          fi

      - name: Send email (per user)
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          subject: Weekly Strava report (${{ matrix.user }})
          to: ${{ env.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}

          body: |
            Attached: weekly Strava report PDFs for ${{ matrix.user }}.

          attachments: |
            reports/figures/${{ matrix.user }}/*.pdf
